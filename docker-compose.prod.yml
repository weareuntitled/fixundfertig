services:
  app:
    build: ./app
    container_name: fixundfertig_app
    environment:
      - APP_BASE_URL=https://${APP_DOMAIN}
      - STORAGE_SECRET=${STORAGE_SECRET}
      - TZ=Europe/Berlin
    volumes:
      - app_storage:/app/storage
    restart: unless-stopped

  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: fixundfertig_n8n
    environment:
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PROTOCOL=https
      - N8N_PORT=5678
      - N8N_EDITOR_BASE_URL=https://${N8N_DOMAIN}
      - WEBHOOK_URL=https://${N8N_DOMAIN}
      - N8N_SECURE_COOKIE=false
      - TZ=Europe/Berlin
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=72
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped

  caddy:
    image: caddy:2
    container_name: fixundfertig_caddy
    ports:
      - "80:80"
      - "443:443"
    environment:
      - APP_DOMAIN=${APP_DOMAIN}
      - N8N_DOMAIN=${N8N_DOMAIN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - app
      - n8n
    restart: unless-stopped

volumes:
  app_storage:
  n8n_data:
  caddy_data:
  caddy_config:
